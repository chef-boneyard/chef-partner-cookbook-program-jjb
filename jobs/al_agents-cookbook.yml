- job:
    name: al_agents-cookbook
    project-type: freestyle
    description: 'verify that the al_agents-cookbook is in a state to push'
    properties:
      - github:
          url: https://github.com/alertlogic/al_agents.git
    scm:
      - git:
         url: https://github.com/alertlogic/al_agents.git
         wipe-workspace: false
         clean: true
    builders:
      - check-markdown-files-are-there
      - shell: |
          #!/bin/bash
          source "$HOME/.rvm/scripts/rvm"
          set -e
          rvm use 2.3.0@al_agents-cookbook --create
          cp /home/jenkins/kitchens/al-agents.kitchen.yml .kitchen.azure.yml
          gem install bundle
          bundle install
          bundle exec rubocop .
          bundle exec foodcritic .
          bundle exec rspec spec
          KITCHEN_YAML=".kitchen.azure.yml" chef exec kitchen test
    wrappers:
      - workspace-cleanup
      - release:
          keep-forever: false
    triggers:
      - timed: "@midnight"
    publishers:
      - slack:
          team-domain: 'chefio'
          auth-token: 'SLACK-AUTH-TOKEN'
          build-server-url: 'https://jenkins-01.eastus.cloudapp.azure.com/'
          room: '#cookbook-partner-prog'
      - post-tasks:
        - matches:
          - log-text: "#gemset created"
          script: |
              #!/bin/bash
              rvm --force gemset delete 2.3.0@al_agents-cookbook
        - matches:
          - log-text: "Class: Kitchen::ActionFailed"
          script: |
              #!/bin/bash
              KITCHEN_YAML=".kitchen.azure.yml" chef exec kitchen list
              KITCHEN_YAML=".kitchen.azure.yml" chef exec kitchen destroy
